name: GitDeployment
run-name: Setting up the GitDeployment Database
on: [push]

jobs:
  connect-local-mssql:
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install SqlServer PowerShell module
        shell: pwsh
        run: |
          Install-Module -Name SqlServer -Force -Scope CurrentUser -AllowClobber

      - name: Connect to Local MS SQL Server
        shell: pwsh
        env:
          LOCAL_SQL_SERVER: ${{ secrets.DB_HOSTNAME }}
          LOCAL_SQL_USER: ${{ secrets.DB_USER }}
          LOCAL_SQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          Import-Module SqlServer
          $server = $env:LOCAL_SQL_SERVER
          if (-not $server) { $server = 'localhost' }
          Write-Host "Connecting to SQL Server: $server"
          $result = Invoke-Sqlcmd -ServerInstance $server -Username $env:LOCAL_SQL_USER -Password $env:LOCAL_SQL_PASSWORD -Query "SELECT @@VERSION as [SQL Server Version];"
          if ($result) {
            Write-Host "✓ Connection successful!"
            Write-Host $result
          } else {
            throw "Failed to connect to SQL Server"
          }

  connect-azure-sql:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Install sqlcmd (mssql-tools)
        run: |
          sudo apt-get update
          sudo apt-get install -y curl apt-transport-https gnupg
          curl https://packages.microsoft.com/keys/microsoft.asc | sudo apt-key add -
          curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
          sudo apt-get update
          sudo ACCEPT_EULA=Y apt-get install -y msodbcsql17 mssql-tools
          echo 'PATH="$PATH:/opt/mssql-tools/bin"' >> $GITHUB_PATH

      - name: Connect to Azure SQL Database
        env:
          AZURE_SQL_SERVER: ${{ secrets.DB_HOSTNAME }}
          AZURE_SQL_DATABASE: ${{ secrets.AZURE_SQL_DATABASE }}
          AZURE_SQL_USER: ${{ secrets.DB_USER }}
          AZURE_SQL_PASSWORD: ${{ secrets.DB_PASSWORD }}
        run: |
          echo "Connecting to Azure SQL Database: $AZURE_SQL_SERVER"
          sqlcmd -S "$AZURE_SQL_SERVER" -d "$AZURE_SQL_DATABASE" -U "$AZURE_SQL_USER" -P "$AZURE_SQL_PASSWORD" -Q "SELECT @@VERSION AS [SQL Server Version], GETDATE() AS [Current Date];"
          if [ $? -eq 0 ]; then
            echo "✓ Connection to Azure SQL Database successful!"
          else
            echo "✗ Failed to connect to Azure SQL Database"
            exit 1
          fi